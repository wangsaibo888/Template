# Supabase ç§¯åˆ†ç³»ç»Ÿæ•°æ®åº“è®¾ç½®

## ğŸ“‹ æ‰§è¡Œé¡ºåº

åœ¨ Supabase Dashboard çš„ SQL ç¼–è¾‘å™¨ä¸­ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡ŒSQLæ–‡ä»¶ï¼š

### 1. æ‰§è¡Œç”¨æˆ·ç§¯åˆ†è¡¨ (å¿…é¡»å…ˆæ‰§è¡Œ)
```sql
-- æ–‡ä»¶: sql/public.user_credits.sql
-- åŒ…å«: è¡¨åˆ›å»ºã€è§¦å‘å™¨ã€å‡½æ•°ã€å®‰å…¨ç­–ç•¥
```

### 2. æ‰§è¡Œç§¯åˆ†å˜åŠ¨è®°å½•è¡¨
```sql
-- æ–‡ä»¶: sql/public.credit_transactions.sql  
-- åŒ…å«: è¡¨åˆ›å»ºã€è§¦å‘å™¨ã€å‡½æ•°ã€å®‰å…¨ç­–ç•¥
```

## ğŸ”§ ç³»ç»ŸåŠŸèƒ½è¯´æ˜

### è‡ªåŠ¨åŒ–åŠŸèƒ½
- âœ… **ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨è·å¾—5ä¸ªç§¯åˆ†**
- âœ… **ç§¯åˆ†å˜åŠ¨æ—¶è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ä½™é¢**
- âœ… **è‡ªåŠ¨è®°å½•æ‰€æœ‰ç§¯åˆ†å˜åŠ¨å†å²**
- âœ… **è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³**

### å®‰å…¨ç­–ç•¥
- ğŸ”’ **è¡Œçº§å®‰å…¨ (RLS)** - ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
- ğŸ”’ **æƒé™æ§åˆ¶** - é˜²æ­¢ç”¨æˆ·ç›´æ¥ä¿®æ”¹ç§¯åˆ†ä½™é¢
- ğŸ”’ **æ•°æ®å®Œæ•´æ€§** - ç¡®ä¿ç§¯åˆ†å˜åŠ¨é€»è¾‘æ­£ç¡®

### ä¸šåŠ¡å‡½æ•°

#### 1. æ¶ˆè€—ç§¯åˆ†
```sql
SELECT spend_credits(
  3,                    -- æ¶ˆè€—æ•°é‡
  'è´­ä¹°å•†å“',            -- æè¿°
  'product-uuid',       -- å…³è”ID (å¯é€‰)
  '{"product_id": 123}' -- å…ƒæ•°æ® (å¯é€‰)
);
```

#### 2. è·å¾—ç§¯åˆ†
```sql
SELECT earn_credits(
  10,                   -- è·å¾—æ•°é‡
  'å®Œæˆä»»åŠ¡',            -- æè¿°
  'task-uuid',          -- å…³è”ID (å¯é€‰)
  '{"task_id": 456}'    -- å…ƒæ•°æ® (å¯é€‰)
);
```

#### 3. æŸ¥è¯¢å½“å‰ç§¯åˆ†
```sql
SELECT * FROM get_user_credits();
```

#### 4. æŸ¥è¯¢ç§¯åˆ†å†å²
```sql
-- è·å–æœ€è¿‘20æ¡è®°å½•
SELECT * FROM get_credit_history();

-- è·å–ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
SELECT * FROM get_credit_history(10, 10);

-- åªæŸ¥çœ‹æ¶ˆè€—è®°å½•
SELECT * FROM get_credit_history(20, 0, 'spend');
```

## ğŸ“Š è¡¨ç»“æ„è¯¦è§£

### user_credits è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | å…³è” auth.users |
| email | TEXT | ç”¨æˆ·é‚®ç®± |
| current_credits | INTEGER | å½“å‰ç§¯åˆ†ä½™é¢ |
| total_earned_credits | INTEGER | ç´¯è®¡è·å¾—ç§¯åˆ† |
| total_spent_credits | INTEGER | ç´¯è®¡æ¶ˆè€—ç§¯åˆ† |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ |

### credit_transactions è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | å…³è” auth.users |
| transaction_type | TEXT | äº¤æ˜“ç±»å‹ (earn/spend/refund/bonus/penalty) |
| amount | INTEGER | å˜åŠ¨æ•°é‡ |
| balance_before | INTEGER | å˜åŠ¨å‰ä½™é¢ |
| balance_after | INTEGER | å˜åŠ¨åä½™é¢ |
| description | TEXT | æè¿° |
| reference_id | UUID | å…³è”ä¸šåŠ¡ID |
| metadata | JSONB | é¢å¤–æ•°æ® |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

æ‰§è¡Œå®ŒSQLåï¼Œæ‚¨å¯ä»¥ï¼š

1. **æ³¨å†Œæ–°ç”¨æˆ·** - è‡ªåŠ¨è·å¾—5ä¸ªç§¯åˆ†
2. **åœ¨åº”ç”¨ä¸­è°ƒç”¨ç§¯åˆ†å‡½æ•°** - æµ‹è¯•æ¶ˆè€—å’Œè·å¾—ç§¯åˆ†
3. **æŸ¥çœ‹ç§¯åˆ†å˜åŠ¨å†å²** - ç¡®è®¤è®°å½•æ­£ç¡®
4. **æµ‹è¯•å®‰å…¨ç­–ç•¥** - ç¡®è®¤ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåºå¾ˆé‡è¦** - å¿…é¡»å…ˆæ‰§è¡Œ user_credits.sql
2. **å¤‡ä»½æ•°æ®** - åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰è¯·å¤‡ä»½
3. **æµ‹è¯•ç¯å¢ƒ** - å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åŠŸèƒ½
4. **æƒé™æ£€æŸ¥** - ç¡®è®¤RLSç­–ç•¥æŒ‰é¢„æœŸå·¥ä½œ

## ğŸ”— ä¸å‰ç«¯é›†æˆ

å‰ç«¯å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨ï¼š

```typescript
// æ¶ˆè€—ç§¯åˆ†
const { data, error } = await supabase.rpc('spend_credits', {
  spend_amount: 3,
  spend_description: 'è´­ä¹°å•†å“'
});

// è·å¾—ç§¯åˆ†  
const { data, error } = await supabase.rpc('earn_credits', {
  earn_amount: 10,
  earn_description: 'å®Œæˆä»»åŠ¡'
});

// æŸ¥è¯¢ç§¯åˆ†
const { data, error } = await supabase.rpc('get_user_credits');

// æŸ¥è¯¢å†å²
const { data, error } = await supabase.rpc('get_credit_history', {
  page_size: 10,
  page_offset: 0
});
``` 